{% extends "base.html" %}
{% load static %}

{% block title %}Student Study Planner{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/planner.css' %}">
{% endblock %}

{% block content %}
<div class="loading-overlay" style="display: none;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"><span class="visually-hidden">Loading...</span></div>
</div>

<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h1 class="mb-2 mb-md-0 h2">Student Study Planner</h1>
        <div class="d-flex align-items-center flex-wrap">
            {# Student selector, populated by JS. Disabled for non-staff users. #}
            <div class="col-12 col-md-auto mb-2 mb-md-0 me-md-2" style="min-width: 200px;">
                <label for="studentSelector" class="form-label visually-hidden">Select Student:</label>
                <select id="studentSelector" class="form-select form-select-sm">
                    <option value="">-- Select Student --</option>
                    {# Options will be populated by JavaScript using initial_data.users #}
                </select>
            </div>
            {# Plan name input #}
            <div class="col-12 col-md-auto" style="min-width: 200px;">
                <input type="text" id="planNameInput" class="form-control form-control-sm" placeholder="Plan Name (e.g., Spring Term Revisions)">
            </div>
        </div>
    </div>

    {# Configuration section for subjects and availability #}
    <div id="config-section" class="card">
        <div class="card-header"><h5 class="mb-0">1. Plan Configuration</h5></div>
        <div class="card-body">
            <div class="mb-3">
                 <label class="form-label">Select up to 6 subjects, their exam dates, priorities, and display colors:</label>
                 <div id="subjects-selection-container">
                    {# Subject input rows will be generated by JavaScript #}
                 </div>
            </div>

            <div id="availability-section" class="mb-3">
                <label class="form-label">2. Typical Weekly Availability (Click to toggle):</label>
                <div id="availability-grid" class="table-responsive">
                    {# Availability grid will be generated by JavaScript #}
                </div>
                <small id="availability-mode-info" class="form-text text-muted">Set your standard available hours. Vacation days use 9am-12pm & 2pm-5pm if scheduled.</small>
            </div>
            
            {# Alert for displaying messages from the generation process or loading status #}
            <div class="alert d-none" id="generation-info" role="alert"></div>
        </div>
    </div>

    {# Main action buttons, visibility controlled by JS based on student selection #}
    <div id="action-buttons-container" class="mt-4 mb-3 text-center" style="display:none;">
        <button id="view-generate-schedule-btn" class="btn btn-success btn-lg me-2">
            <i class="bi bi-calendar-week-fill"></i> View / Generate Schedule
        </button>
        <button id="save-plan-btn" class="btn btn-primary btn-lg me-2">
            <i class="bi bi-save-fill"></i> Save Plan
        </button>
        <button id="export-schedule-html-btn" class="btn btn-info btn-lg">
            <i class="bi bi-download"></i> Export Schedule HTML
        </button>
    </div>
    
    {# Section to display the generated schedule #}
    <div id="schedule-section" class="card mt-4" style="display:none;">
         <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">3. Generated Schedule <small class="text-muted fs-6 fw-normal">(Click a slot to edit)</small></h5>
            {# Export button moved to main actions for better visibility #}
        </div>
        <div class="card-body">
            <div id="schedule-calendar-container" class="table-responsive">
                {# Schedule calendar will be populated by JavaScript #}
            </div>
        </div>
    </div>

</div>

{# Modal for editing a schedule slot #}
<div class="modal fade" id="editSlotModal" tabindex="-1" aria-labelledby="editSlotModalLabel" aria-hidden="true">
    <div class="modal-dialog"> 
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSlotModalLabel">Edit Slot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Date: <strong id="slot-modal-date"></strong>, Time: <strong id="slot-modal-time"></strong></p>
                <label for="slot-subject-select" class="form-label">Assign Subject:</label>
                <select id="slot-subject-select" class="form-select">
                    <option value="">-- Free / Break --</option>
                    {# Subject options for the modal will be populated by JavaScript #}
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-slot-changes-btn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
    {# Pass data from the Django view to JavaScript #}
    {{ initial_data|json_script:"initial-data-json" }}
    {{ api_config|json_script:"api-config-json" }}

    <script src="{% static 'js/student_planner.js' %}"></script>
{% endblock %}
